From c8330b6e7f57dbaf95e033d2a94ed8ddd3bfd69a Mon Sep 17 00:00:00 2001
From: Erfan Abdi <erfangplus@gmail.com>
Date: Sat, 29 May 2021 10:21:50 +0800
Subject: [PATCH] EGL: Add vendor_extra to search paths

Change-Id: I650d8b092f530ac6ff8bd56e8ef7845c1d4d85c2
---
 opengl/libs/EGL/Loader.cpp | 21 ++++++++++++++++++---
 1 file changed, 18 insertions(+), 3 deletions(-)

diff --git a/opengl/libs/EGL/Loader.cpp b/opengl/libs/EGL/Loader.cpp
index 038a43233..d56eebb5f 100644
--- a/opengl/libs/EGL/Loader.cpp
+++ b/opengl/libs/EGL/Loader.cpp
@@ -435,7 +435,8 @@ static void* load_system_driver(const char* kind, const char* suffix, const bool
     ATRACE_CALL();
     class MatchFile {
     public:
-        static std::string find(const char* libraryName, const bool exact) {
+        static std::string find(const char* libraryName, const bool exact, const char* suffix) {
+            bool useExtra = true;
             const char* const searchPaths[] = {
 #if defined(__LP64__)
                     "/vendor/lib64/egl",
@@ -445,8 +446,22 @@ static void* load_system_driver(const char* kind, const char* suffix, const bool
                     "/system/lib/egl"
 #endif
             };
+            const char* const searchPathsExtra[] = {
+#if defined(__LP64__)
+                    "/vendor_extra/lib64/egl",
+                    "/system/lib64/egl"
+#else
+                    "/vendor_extra/lib/egl",
+                    "/system/lib/egl"
+#endif
+            };
+
+            if (suffix) {
+                if (!strcmp(suffix, "mesa"))
+                    useExtra = false;
+            }
 
-            for (auto dir : searchPaths) {
+            for (auto dir : (useExtra ? searchPathsExtra : searchPaths)) {
                 std::string absolutePath;
                 if (find(absolutePath, libraryName, dir, exact)) {
                     return absolutePath;
@@ -502,7 +517,7 @@ static void* load_system_driver(const char* kind, const char* suffix, const bool
         //      libEGL_*.so, libGLESv1_CM_*.so, libGLESv2_*.so
         libraryName += std::string("_");
     }
-    std::string absolutePath = MatchFile::find(libraryName.c_str(), exact);
+    std::string absolutePath = MatchFile::find(libraryName.c_str(), exact, suffix);
     if (absolutePath.empty()) {
         // this happens often, we don't want to log an error
         return nullptr;
-- 
2.29.2

