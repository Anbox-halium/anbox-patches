From 7e0dd758bfb8c8f18975c77b428596ee78b93433 Mon Sep 17 00:00:00 2001
From: utzcoz <utzcoz@outlook.com>
Date: Sun, 13 Sep 2020 16:45:34 +0800
Subject: [PATCH 23/25] Don't throw exception for setShelfHeight checking

If we change default overview recents component, the Launcher3QuickStep
will crash because it doesn't have STATE_BAR permission and is not
recents app when it tryies to invoke setShelfHeight. We will change
default recents app, and keep Launcher3QuickStep, so we should disable
throwing exception, and just do nothing for method invokeing.

Signed-off-by: utzcoz <utzcoz@outlook.com>
---
 .../com/android/server/wm/WindowManagerService.java | 13 +++++++++++--
 1 file changed, 11 insertions(+), 2 deletions(-)

diff --git a/services/core/java/com/android/server/wm/WindowManagerService.java b/services/core/java/com/android/server/wm/WindowManagerService.java
index 9478991e9b94..813d7562e5e3 100644
--- a/services/core/java/com/android/server/wm/WindowManagerService.java
+++ b/services/core/java/com/android/server/wm/WindowManagerService.java
@@ -5696,8 +5696,17 @@ public class WindowManagerService extends IWindowManager.Stub
 
     @Override
     public void setShelfHeight(boolean visible, int shelfHeight) {
-        mAtmInternal.enforceCallerIsRecentsOrHasPermission(android.Manifest.permission.STATUS_BAR,
-                "setShelfHeight()");
+        // region @boringdroid
+        try {
+            mAtmInternal.enforceCallerIsRecentsOrHasPermission(android.Manifest.permission.STATUS_BAR,
+                    "setShelfHeight()");
+        } catch (SecurityException e) {
+            Slog.e(TAG, "Need permision android.Manifest.permission.STATUS_BAR for setShelfHeight", e);
+            return;
+        }
+        // mAtmInternal.enforceCallerIsRecentsOrHasPermission(android.Manifest.permission.STATUS_BAR,
+        //         "setShelfHeight()");
+        // endregion
         synchronized (mGlobalLock) {
             getDefaultDisplayContentLocked().getPinnedStackController().setAdjustedForShelf(visible,
                     shelfHeight);
-- 
2.25.1

